# Currency System

> í™•ì¥ ê°€ëŠ¥í•˜ê³  ì•ˆì „í•œ ì¸ê²Œì„ í™”í ê´€ë¦¬ ì‹œìŠ¤í…œ
>
> ScriptableObject Databaseì™€ Save/Loadë¥¼ í™œìš©í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ê²½ì œ ì‹œìŠ¤í…œ

## ğŸ“‹ ëª©ì°¨

- [ê°œìš”](#ê°œìš”)
- [ë””ë ‰í† ë¦¬ êµ¬ì¡°](#ë””ë ‰í† ë¦¬-êµ¬ì¡°)
- [ì ìš©ëœ ë””ìì¸ íŒ¨í„´](#ì ìš©ëœ-ë””ìì¸-íŒ¨í„´)
- [í•µì‹¬ ê¸°ëŠ¥](#í•µì‹¬-ê¸°ëŠ¥)
- [ì£¼ìš” API](#ì£¼ìš”-api)
- [ì‚¬ìš© ì˜ˆì‹œ](#ì‚¬ìš©-ì˜ˆì‹œ)
- [ê¸°ìˆ ì  ì˜ì‚¬ê²°ì •](#ê¸°ìˆ ì -ì˜ì‚¬ê²°ì •)

---

## ê°œìš”

CurrencySystemì€ ê²Œì„ ë‚´ **í™”í ê´€ë¦¬**ë¥¼ ë‹´ë‹¹í•˜ëŠ” í•µì‹¬ ëª¨ë“ˆì…ë‹ˆë‹¤. ê³¨ë“œ, ë‹¤ì´ì•„, í‹°ì¼“ ë“± ë‹¤ì–‘í•œ í™”íë¥¼ ì¤‘ì•™ì—ì„œ ê´€ë¦¬í•˜ë©°, **ë©€í‹°ìŠ¤ë ˆë“œ ë¹„ë™ê¸° ì €ì¥**ìœ¼ë¡œ í”„ë ˆì„ ë“œë¡­ ì—†ëŠ” í”„ë¡œë•ì…˜ ìˆ˜ì¤€ì˜ ì„±ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

### ì£¼ìš” íŠ¹ì§• â­

- ğŸš€ **ë©€í‹°ìŠ¤ë ˆë“œ ë¹„ë™ê¸° ì €ì¥** - ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ 0, í”„ë ˆì„ ë“œë¡­ ë°©ì§€
  - CPU Bound(JSON ì§ë ¬í™”, AES ì•”í˜¸í™”)ë¥¼ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ì²˜ë¦¬
  - I/O Bound(íŒŒì¼ ì“°ê¸°)ë¥¼ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬
  - UniTask ê¸°ë°˜ ì œë¡œ GC í• ë‹¹
- âš¡ **ìŠ¤ë§ˆíŠ¸ ì €ì¥ ìµœì í™”** - Debouncing + Pending Save + Dirty Flag
  - I/O ë¹ˆë„ ìµœëŒ€ 90% ê°ì†Œ
  - ë°ì´í„° ì†ì‹¤ ë°©ì§€
- âœ… **ScriptableObject Database**ë¡œ ëª¨ë“  í™”íë¥¼ ì¤‘ì•™ ê´€ë¦¬
- âœ… **ì˜êµ¬/ë¹„ì˜êµ¬ í™”í** êµ¬ë¶„ ë° ìë™ ì €ì¥
- âœ… **ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜**ë¡œ ëŠìŠ¨í•œ ê²°í•©
- âœ… **Dictionary ìºì‹±**ìœ¼ë¡œ O(1) ì¡°íšŒ ì„±ëŠ¥

---

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
CurrencySystem/
â”œâ”€â”€ CurrencyManager.cs          # Singleton ë§¤ë‹ˆì € (Save/Load)
â”œâ”€â”€ Currency.cs                 # í™”í ë°ì´í„° í´ë˜ìŠ¤
â”œâ”€â”€ CurrencyDatabaseSO.cs       # ScriptableObject ë°ì´í„°ë² ì´ìŠ¤
â”œâ”€â”€ CurrencyData.cs             # ì €ì¥ìš© ë°ì´í„° êµ¬ì¡°ì²´
â”œâ”€â”€ CurrencyState.cs            # í™”í ìƒíƒœ (amount, totalAmount)
â”œâ”€â”€ Editor/
â”‚   â”œâ”€â”€ CurrencyDatabaseWindow.cs    # ì»¤ìŠ¤í…€ ì—ë””í„° ìœˆë„ìš°
â”‚   â””â”€â”€ CurrencyDatabaseCreator.cs   # ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± ìœ í‹¸ë¦¬í‹°
â””â”€â”€ Sample/                     # ìƒ˜í”Œ ì”¬ ë° ì˜ˆì œ
```

**í•µì‹¬ íŒŒì¼:**
- [`CurrencyManager.cs`](CurrencyManager.cs): Singleton íŒ¨í„´, Save/Load ë‹´ë‹¹
- [`Currency.cs`](Currency.cs): í™”í ë°ì´í„° ë° ë¡œì§ (Earn, Use)
- [`CurrencyDatabaseSO.cs`](CurrencyDatabaseSO.cs): ScriptableObject ê¸°ë°˜ DB

---

## ì ìš©ëœ ë””ìì¸ íŒ¨í„´

### 1. ë©€í‹°ìŠ¤ë ˆë“œ ë¹„ë™ê¸° íŒ¨í„´ (Async/Await + UniTask) ğŸš€

**í•µì‹¬ ëª©í‘œ: ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ ì™„ì „ ì œê±°**

CPU Bound(ì§ë ¬í™”, ì•”í˜¸í™”)ì™€ I/O Bound(íŒŒì¼ ì“°ê¸°) ì‘ì—…ì„ **ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ**ì—ì„œ ì²˜ë¦¬í•˜ì—¬ ë©”ì¸ ìŠ¤ë ˆë“œë¥¼ ì™„ì „íˆ ììœ ë¡­ê²Œ ë§Œë“­ë‹ˆë‹¤.

**ë¬¸ì œ ìƒí™©:**
```csharp
// âŒ ë™ê¸° ì €ì¥ (Before): ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡
void Save()
{
    string json = JsonConvert.SerializeObject(data);    // CPU Bound: ë©”ì¸ ìŠ¤ë ˆë“œ ì ìœ 
    string encrypted = FileIO.EncryptString(json);       // CPU Bound: ë©”ì¸ ìŠ¤ë ˆë“œ ì ìœ 
    File.WriteAllText(path, encrypted);                  // I/O Bound: ë©”ì¸ ìŠ¤ë ˆë“œ ëŒ€ê¸°
    // â†’ ì´ 100ms ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ â†’ í”„ë ˆì„ ë“œë¡­ ë°œìƒ
}
```

**í•´ê²° ë°©ë²•:**
```csharp
// âœ… ë¹„ë™ê¸° ì €ì¥ (After): ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ
async UniTask SaveAsync()
{
    await UniTask.RunOnThreadPool(() =>  // ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œë¡œ ì´ë™
    {
        string json = JsonConvert.SerializeObject(data);    // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
        string encrypted = FileIO.EncryptString(json);       // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
        File.WriteAllText(path, encrypted);                  // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
    });
    // â†’ ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ 0ms â†’ í”„ë ˆì„ ë“œë¡­ 0
}
```

**íš¨ê³¼:**
- âœ… **ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ 0ms** - ê²Œì„ ë¡œì§ì´ ì €ì¥ê³¼ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰
- âœ… **í”„ë ˆì„ ë“œë¡­ ë°©ì§€** - 60fps ìœ ì§€ (ëª¨ë°”ì¼ ì¤‘ìš”)
- âœ… **ì•”í˜¸í™” ì—°ì‚° ë¶€í•˜ ì œê±°** - AES ì•”í˜¸í™”ë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬

**CPU Bound vs I/O Bound:**

| ì‘ì—… íƒ€ì… | ì˜ˆì‹œ | íŠ¹ì§• | ì²˜ë¦¬ ë°©ë²• |
|----------|------|------|----------|
| **CPU Bound** | JSON ì§ë ¬í™”, AES ì•”í˜¸í™” | CPU ì—°ì‚° ì‹œê°„ ì†Œìš” | `UniTask.RunOnThreadPool()` |
| **I/O Bound** | íŒŒì¼ ì½ê¸°/ì“°ê¸° | ë””ìŠ¤í¬ ëŒ€ê¸° ì‹œê°„ | `await` ë¹„ë™ê¸° ì²˜ë¦¬ |

**UniTask ì„ íƒ ì´ìœ :**

| í•­ëª© | C# Task | UniTask â­ |
|------|---------|-----------|
| GC í• ë‹¹ | ìˆìŒ (class ê¸°ë°˜) | **ì œë¡œ** (ValueTask ê¸°ë°˜) |
| Unity í†µí•© | ìˆ˜ë™ ì²˜ë¦¬ | **PlayerLoop ìë™ í†µí•©** |
| ì„±ëŠ¥ | ë²”ìš© | **Unity ìµœì í™”** |
| ì˜ì¡´ì„± | ì—†ìŒ (í‘œì¤€) | íŒ¨í‚¤ì§€ í•„ìš” |

**Trade-off:**
- âœ… ì„ íƒ: UniTask - ëª¨ë°”ì¼ íƒ€ê²Ÿ + ë¹ˆë²ˆí•œ ì €ì¥ â†’ ì œë¡œ GCê°€ ì¤‘ìš”
- âŒ ë°°ì œ: C# Task - GC í• ë‹¹ì´ ëˆ„ì ë˜ì–´ í”„ë ˆì„ ë“œë¡­ ìœ ë°œ ê°€ëŠ¥

**ì°¸ê³ :** [`DataManager.cs:55-99`](../Utils/DataManager.cs)

---

### 2. Debouncing Pattern + Max Wait Time â­

ì§§ì€ ì‹œê°„ ë‚´ ì—¬ëŸ¬ ì €ì¥ ìš”ì²­ ë°œìƒ ì‹œ ë§ˆì§€ë§‰ ìš”ì²­ë§Œ ì‹¤í–‰í•˜ì—¬ I/O ë¹ˆë„ë¥¼ ê°ì†Œì‹œí‚¤ë©°, **ìµœëŒ€ ëŒ€ê¸° ì‹œê°„**ì„ ì„¤ì •í•˜ì—¬ ì €ì¥ì´ ë¬´í•œ ì—°ê¸°ë˜ì§€ ì•Šë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

**ë™ì‘ ì›ë¦¬:**
- ì €ì¥ ìš”ì²­ ë°œìƒ â†’ ì²« í˜¸ì¶œ ì‹œê°„ ê¸°ë¡, íƒ€ì´ë¨¸ ì‹œì‘ (0.5ì´ˆ)
- íƒ€ì´ë¨¸ ì™„ë£Œ ì „ ì¬ìš”ì²­ â†’ ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ, ìƒˆ íƒ€ì´ë¨¸ ì‹œì‘
- **ëŒ€ê¸° ì‹œê°„ì´ 5ì´ˆ ì´ˆê³¼ â†’ Debounce ë¬´ì‹œ, ì¦‰ì‹œ ì €ì¥** â† í•µì‹¬!
- íƒ€ì´ë¨¸ ì™„ë£Œ â†’ ì‹¤ì œ ì €ì¥ ì‹¤í–‰

**ì™œ Max Wait Timeì´ í•„ìš”í•œê°€?**

**ë¬¸ì œ (ê¸°ì•„ ìƒíƒœ):**
```
0.0ì´ˆ: RequestSave() â†’ íƒ€ì´ë¨¸ 0.5ì´ˆ
0.1ì´ˆ: RequestSave() â†’ íƒ€ì´ë¨¸ ì·¨ì†Œ, ìƒˆë¡œ 0.5ì´ˆ
0.2ì´ˆ: RequestSave() â†’ íƒ€ì´ë¨¸ ì·¨ì†Œ, ìƒˆë¡œ 0.5ì´ˆ
... (0.1ì´ˆë§ˆë‹¤ ê³„ì† í˜¸ì¶œ)
âˆì´ˆ: ì˜ì›íˆ ì €ì¥ ì•ˆ ë¨! âŒ
```

**í•´ê²° (Max Wait Time):**
```
0.0ì´ˆ: RequestSave() â†’ firstCallTime = 0.0, íƒ€ì´ë¨¸ 0.5ì´ˆ
0.1ì´ˆ: RequestSave() â†’ waitedTime = 0.1ì´ˆ, íƒ€ì´ë¨¸ ì·¨ì†Œ, ìƒˆë¡œ 0.5ì´ˆ
0.2ì´ˆ: RequestSave() â†’ waitedTime = 0.2ì´ˆ, íƒ€ì´ë¨¸ ì·¨ì†Œ, ìƒˆë¡œ 0.5ì´ˆ
...
5.0ì´ˆ: RequestSave() â†’ waitedTime = 5.0ì´ˆ â‰¥ maxWaitTime
                       â†’ Debounce ë¬´ì‹œ, ì¦‰ì‹œ ì €ì¥! âœ…
```

**íš¨ê³¼:**
- âœ… ë¹ ë¥¸ ì—°ì† í˜¸ì¶œ â†’ I/O ë¹ˆë„ ê°ì†Œ (ìµœì í™”)
- âœ… ì§€ì†ì  í˜¸ì¶œ â†’ 5ì´ˆë§ˆë‹¤ ìµœì†Œ 1ë²ˆ ì €ì¥ ë³´ì¥ (ì•ˆì „ì„±)

```csharp
// Debouncing + Max Wait Time êµ¬í˜„ (CurrencyManager.cs:77-121)
public async void RequestSave()
{
    isDirty = true;

    // ì²« í˜¸ì¶œ ì‹œê°„ ê¸°ë¡
    if (firstCallTime == null)
    {
        firstCallTime = Time.time;
    }

    // Max Wait Time ì²´í¬ - ë„ˆë¬´ ì˜¤ë˜ ê¸°ë‹¤ë ¸ìœ¼ë©´ ì¦‰ì‹œ ì €ì¥
    float waitedTime = Time.time - firstCallTime.Value;
    if (waitedTime >= maxWaitTime)
    {
        Debug.Log("MaxWaitTime ì´ˆê³¼ â†’ ê°•ì œ ì €ì¥");
        firstCallTime = null;
        await ExecuteSave();
        return;
    }

    // Debouncing: ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
    debounceCts?.Cancel();
    debounceCts = new CancellationTokenSource();

    // ë‚¨ì€ ì‹œê°„ë§Œí¼ë§Œ ëŒ€ê¸°
    float remainingTime = maxWaitTime - waitedTime;
    float actualDebounceTime = Mathf.Min(debounceTime, remainingTime);

    await UniTask.Delay(TimeSpan.FromSeconds(actualDebounceTime),
        cancellationToken: debounceCts.Token);

    firstCallTime = null; // ë¦¬ì…‹
    await ExecuteSave();
}
```

---

### 3. Pending Save Pattern â­

I/O ì‘ì—… ì§„í–‰ ì¤‘ ìƒˆë¡œìš´ ì €ì¥ ìš”ì²­ì´ ì˜¤ë©´ ì™„ë£Œ í›„ ì¬ì‹¤í–‰í•˜ì—¬ ë°ì´í„° ì†ì‹¤ì„ ë°©ì§€í•©ë‹ˆë‹¤.

**ë™ì‘ ì›ë¦¬:**
- ì €ì¥ ì¤‘(`currentSaveTask != null`) â†’ `isDirty` í”Œë˜ê·¸ë§Œ ì„¸ì›€
- I/O ì™„ë£Œ â†’ `isDirty` ì²´í¬ í›„ ì¬ì €ì¥

**íš¨ê³¼:**
- I/O ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
- ë°ì´í„° ì†ì‹¤ ë°©ì§€ (ë§ˆì§€ë§‰ ë³€ê²½ì‚¬í•­ ë³´ì¥)

```csharp
// Pending Save êµ¬í˜„ (CurrencyManager.cs:87-98)
if (currentSaveTask != null && !currentSaveTask.Value.Status.IsCompleted())
{
    await currentSaveTask.Value; // I/O ì™„ë£Œ ëŒ€ê¸°
}

if (isDirty)
{
    isDirty = false;
    currentSaveTask = SaveAsync(); // ì¬ì €ì¥
    await currentSaveTask.Value;
}
```

---

### 4. Dirty Flag Pattern â­

ì‹¤ì œ ë°ì´í„° ë³€ê²½ì´ ìˆì„ ë•Œë§Œ ì €ì¥ì„ ìˆ˜í–‰í•˜ì—¬ ë¶ˆí•„ìš”í•œ I/Oë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

**ë™ì‘ ì›ë¦¬:**
- ë°ì´í„° ë³€ê²½ ë°œìƒ â†’ `isDirty = true`
- ì €ì¥ ì‹¤í–‰ â†’ `isDirty = false`
- ì €ì¥ ì‹œì ì— `isDirty` ì²´í¬ â†’ trueì¼ ë•Œë§Œ ì‹¤í–‰

**íš¨ê³¼:**
- ì¤‘ë³µ ì €ì¥ ë°©ì§€
- I/O íšŸìˆ˜ ìµœì†Œí™”

---

### 5. Singleton Pattern

ì „ì—­ ì ‘ê·¼ ê°€ëŠ¥í•œ ë‹¨ì¼ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤ (DontDestroyOnLoad)

---

### 6. Event-Driven Architecture

í™”í ë³€ê²½ ì‹œ `onAmountChanged` ì´ë²¤íŠ¸ ë°œìƒìœ¼ë¡œ UI ë“± ë‹¤ë¥¸ ì‹œìŠ¤í…œì— ìë™ í†µì§€

---

### 7. Repository Pattern (Dictionary Cache)

Title ê¸°ë°˜ Dictionary ìºì‹±ìœ¼ë¡œ O(1) ì¡°íšŒ ì„±ëŠ¥

---

## í•µì‹¬ ê¸°ëŠ¥

### 1. ì˜êµ¬ / ë¹„ì˜êµ¬ í™”í

**ì˜êµ¬ í™”í (Permanent):**
- ê²Œì„ ì¢…ë£Œ í›„ì—ë„ ìœ ì§€ (ì˜ˆ: ê³¨ë“œ, ë‹¤ì´ì•„)
- ë³€ê²½ ì‹œ ìë™ ì €ì¥
- `IsPermanent = true`

```csharp
if (currency.IsPermanent)
{
    madeCurrency.onAmountChanged += (noUse) => Save();
}
```

**ë¹„ì˜êµ¬ í™”í (Non-Permanent):**
- ê²Œì„ ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë¦¬ì…‹ (ì˜ˆ: ìŠ¤í…Œì´ì§€ ì½”ì¸)
- ì €ì¥í•˜ì§€ ì•ŠìŒ
- `IsPermanent = false`

---

### 2. ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

ì¤‘ë³µ Title ê²€ì¦ (`Editor_Validate()`) ë° ì”ì•¡ ë¶€ì¡± ì‹œ ì‹¤íŒ¨ ë°˜í™˜

---

### 3. ë©€í‹°ìŠ¤ë ˆë“œ ë¹„ë™ê¸° ì €ì¥ ì‹œìŠ¤í…œ ğŸš€

**ë©”ì¸ ìŠ¤ë ˆë“œì™€ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì˜ ë¶„ë¦¬:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë©”ì¸ ìŠ¤ë ˆë“œ (Main Thread)                                    â”‚
â”‚ - ê²Œì„ ë¡œì§, ë Œë”ë§, ë¬¼ë¦¬ ì—°ì‚° (60fps ìœ ì§€ í•„ìˆ˜)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        í™”í ë³€ê²½ â†’ RequestSave() í˜¸ì¶œ
                        â”‚
            [Debouncing] 0.5ì´ˆ ëŒ€ê¸°
                        â”‚
        [Pending Save] ì €ì¥ ì¤‘ì´ë©´ ëŒ€ê¸°
                        â”‚
            [Dirty Flag] ë³€ê²½ì‚¬í•­ ì²´í¬
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ (Background Thread)                         â”‚
â”‚ - SaveAsync() ì‹¤í–‰                                           â”‚
â”‚   â”œâ”€ JSON ì§ë ¬í™” (CPU Bound) â† ì•”í˜¸í™” ì „ ì¤€ë¹„               â”‚
â”‚   â”œâ”€ AES ì•”í˜¸í™” (CPU Bound)  â† ë¬´ê±°ìš´ ì—°ì‚°                  â”‚
â”‚   â””â”€ íŒŒì¼ ì“°ê¸° (I/O Bound)   â† ë””ìŠ¤í¬ ëŒ€ê¸°                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                ì™„ë£Œ í›„ ë©”ì¸ ìŠ¤ë ˆë“œ ë³µê·€
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë©”ì¸ ìŠ¤ë ˆë“œ (Main Thread)                                    â”‚
â”‚ - ì €ì¥ ì™„ë£Œ ë¡œê·¸ ì¶œë ¥                                         â”‚
â”‚ - ê²Œì„ ë¡œì§ì€ ë©ˆì¶”ì§€ ì•Šê³  ê³„ì† ì‹¤í–‰ë¨ âœ…                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ:**

**ì‹œë‚˜ë¦¬ì˜¤ 1: ë¹ ë¥¸ ì—°ì† í˜¸ì¶œ (Debouncing íš¨ê³¼)**
```
0.0ì´ˆ: EarnCurrency í˜¸ì¶œ â†’ RequestSave() (firstCallTime = 0.0)
0.1ì´ˆ: EarnCurrency í˜¸ì¶œ â†’ RequestSave() (ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ)
0.2ì´ˆ: EarnCurrency í˜¸ì¶œ â†’ RequestSave() (ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ)
0.7ì´ˆ: Debounce ì™„ë£Œ â†’ SaveAsync() 1ë²ˆë§Œ ì‹¤í–‰ âœ…
      firstCallTime = null (ë¦¬ì…‹)
```

**ì‹œë‚˜ë¦¬ì˜¤ 2: ì§€ì†ì  í˜¸ì¶œ (Max Wait Time íš¨ê³¼)**
```
0.0ì´ˆ: RequestSave() â†’ firstCallTime = 0.0, íƒ€ì´ë¨¸ 0.5ì´ˆ
0.1ì´ˆ: RequestSave() â†’ waitedTime = 0.1ì´ˆ, íƒ€ì´ë¨¸ ì·¨ì†Œ
0.2ì´ˆ: RequestSave() â†’ waitedTime = 0.2ì´ˆ, íƒ€ì´ë¨¸ ì·¨ì†Œ
... (0.1ì´ˆë§ˆë‹¤ ê³„ì† í˜¸ì¶œ)
5.0ì´ˆ: RequestSave() â†’ waitedTime = 5.0ì´ˆ â‰¥ maxWaitTime
                       â†’ Debounce ë¬´ì‹œ, ì¦‰ì‹œ ì €ì¥! âœ…
      firstCallTime = null (ë¦¬ì…‹)
5.1ì´ˆ: RequestSave() â†’ firstCallTime = 5.1 (ìƒˆë¡œ ì‹œì‘)
10.1ì´ˆ: ë˜ 5ì´ˆ ì´ˆê³¼ â†’ ê°•ì œ ì €ì¥ âœ…
```

**ì‹œë‚˜ë¦¬ì˜¤ 3: I/O ì§„í–‰ ì¤‘ í˜¸ì¶œ (Pending Save íš¨ê³¼)**
```
0.0ì´ˆ: RequestSave() â†’ SaveAsync() ì‹œì‘ (2ì´ˆ ì†Œìš”)
0.5ì´ˆ: RequestSave() í˜¸ì¶œ â†’ isDirty = true, I/O ëŒ€ê¸°
2.0ì´ˆ: SaveAsync() ì™„ë£Œ â†’ isDirty ì²´í¬ â†’ ì¬ì €ì¥ âœ…
```

**ì„±ëŠ¥ ê°œì„  íš¨ê³¼:**

| í•­ëª© | Before (ë™ê¸°) | After (ë¹„ë™ê¸°) | ê°œì„  |
|------|--------------|---------------|------|
| **ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡** | 100ms | **0ms** | âœ… **í”„ë ˆì„ ë“œë¡­ 0** |
| **I/O ë¹ˆë„** | 10ë²ˆ/ì´ˆ | 2ë²ˆ/ì´ˆ | âœ… **90% ê°ì†Œ** |
| **ì•”í˜¸í™” ë¶€í•˜** | ë©”ì¸ ìŠ¤ë ˆë“œ | ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ | âœ… **ë©”ì¸ ìŠ¤ë ˆë“œ ììœ ** |
| **60fps ìœ ì§€** | âŒ í”„ë ˆì„ ë“œë¡­ | âœ… ì•ˆì •ì  ìœ ì§€ | âœ… **ëª¨ë°”ì¼ í•„ìˆ˜** |
| **ë°°í„°ë¦¬ ì†Œëª¨** | ë†’ìŒ | ë‚®ìŒ | âœ… **ëª¨ë°”ì¼ ìµœì í™”** |

---

### 4. ì»¤ìŠ¤í…€ ì—ë””í„° ìœˆë„ìš°

`Window â†’ Game â†’ Currency Database`ì—ì„œ í™”í ì¶”ê°€/í¸ì§‘/ì‚­ì œ

---

## ì£¼ìš” API

### CurrencyManager

**í™”í ì¡°íšŒ:**
- `GetCurrencyAmount(string title)` - í˜„ì¬ ë³´ìœ ëŸ‰
- `GetCurrencyTotalAmount(string title)` - ëˆ„ì  íšë“ëŸ‰
- `FindCurrencyByTitle(string title)` - Currency ê°ì²´ ì¡°íšŒ

**í™”í ì‚¬ìš©:**
- `EarnCurrency(string title, long amount)` - í™”í íšë“
- `UseCurrency(string title, long amount)` - í™”í ì‚¬ìš© (ì”ì•¡ ë¶€ì¡± ì‹œ false)

**ì´ë²¤íŠ¸ êµ¬ë…:**
- `AddActionCurrency(string title, Action<long> action)` - ì´ë²¤íŠ¸ êµ¬ë…
- `RemoveActionCurrency(string title, Action<long> action)` - ì´ë²¤íŠ¸ í•´ì œ

**ì €ì¥/ë¡œë“œ:**
- `RequestSave()` - ë¹„ë™ê¸° ì €ì¥ ìš”ì²­ (Debouncing + Pending Save) â­ ê¶Œì¥
- `Save()` - ì¦‰ì‹œ ë™ê¸° ì €ì¥ (Legacy, ì—ë””í„° ì „ìš©)
- `Load()` - ë™ê¸° ë¡œë“œ (Legacy, HaveLoad ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„)

**ë¹„ë™ê¸° ë‚´ë¶€ ë©”ì„œë“œ:**
- `SaveAsync()` - UniTask ê¸°ë°˜ ë¹„ë™ê¸° ì €ì¥
- `LoadAsync()` - UniTask ê¸°ë°˜ ë¹„ë™ê¸° ë¡œë“œ (Start()ì—ì„œ í˜¸ì¶œ)

---

### Currency

**ë°ì´í„° ì ‘ê·¼:**
- `Title` - í™”í ì´ë¦„ (ê³ ìœ  ID)
- `Description` - í™”í ì„¤ëª…
- `Icon` - í™”í ì•„ì´ì½˜
- `IsPermanent` - ì˜êµ¬ í™”í ì—¬ë¶€
- `Amount` - í˜„ì¬ ë³´ìœ ëŸ‰
- `TotalAmount` - ëˆ„ì  íšë“ëŸ‰

**ë¡œì§:**
- `Earn(long amount)` - í™”í íšë“
- `Use(long amount)` - í™”í ì‚¬ìš© (ì„±ê³µ ì—¬ë¶€ ë°˜í™˜)

**ì´ë²¤íŠ¸:**
- `onAmountChanged` - ë³´ìœ ëŸ‰ ë³€ê²½ ì‹œ
- `onTotalAmountChanged` - ëˆ„ì ëŸ‰ ë³€ê²½ ì‹œ

---

## ì‚¬ìš© ì˜ˆì‹œ

### ê¸°ë³¸ ì‚¬ìš©ë²•

```csharp
// 1. í™”í íšë“
CurrencyManager.Instance.EarnCurrency("Gold", 100);

// 2. í™”í ì‚¬ìš©
bool success = CurrencyManager.Instance.UseCurrency("Gold", 50);
if (success)
{
    Debug.Log("êµ¬ë§¤ ì„±ê³µ!");
}
else
{
    Debug.Log("ê³¨ë“œ ë¶€ì¡±!");
}

// 3. í˜„ì¬ ë³´ìœ ëŸ‰ ì¡°íšŒ
long goldAmount = CurrencyManager.Instance.GetCurrencyAmount("Gold");
Debug.Log($"ë³´ìœ  ê³¨ë“œ: {goldAmount}");
```

---

### ì´ë²¤íŠ¸ êµ¬ë…

```csharp
public class ShopSystem : MonoBehaviour
{
    private void Start()
    {
        // ê³¨ë“œ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
        CurrencyManager.Instance.AddActionCurrency("Gold", OnGoldChanged);
    }

    private void OnDestroy()
    {
        // ì´ë²¤íŠ¸ í•´ì œ
        CurrencyManager.Instance.RemoveActionCurrency("Gold", OnGoldChanged);
    }

    private void OnGoldChanged(long newAmount)
    {
        Debug.Log($"í˜„ì¬ ê³¨ë“œ: {newAmount}");
    }
}
```

---

### ìƒˆë¡œìš´ í™”í ì¶”ê°€

1. `Window â†’ Game â†’ Currency Database` ì—´ê¸°
2. Add New Currency â†’ Title, Icon, IsPermanent ì„¤ì •
3. ì½”ë“œì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥: `CurrencyManager.Instance.EarnCurrency("NewCurrency", 10);`

---

## ê¸°ìˆ ì  ì˜ì‚¬ê²°ì •

### 1. ScriptableObject vs MonoBehaviour

**ë¬¸ì œ:** í™”í ë°ì´í„°ë¥¼ ì–´ë””ì— ì €ì¥í•  ê²ƒì¸ê°€?

**ê²°ì •:** ScriptableObject Database ì‚¬ìš©

**ì´ìœ :**
- ì”¬ ë…ë¦½ì  (ëª¨ë“  ì”¬ì—ì„œ ë™ì¼ ë°ì´í„° ì°¸ì¡°)
- ì—ì…‹ìœ¼ë¡œ ê´€ë¦¬ (ë²„ì „ ê´€ë¦¬ ìš©ì´)
- Inspector í¸ì§‘ ê°€ëŠ¥ (ë””ìì´ë„ˆ ì¹œí™”ì )

---

### 2. Dictionary vs List

**ë¬¸ì œ:** í™”í ê²€ìƒ‰ì„ ì–´ë–»ê²Œ ìµœì í™”í•  ê²ƒì¸ê°€?

**ê²°ì •:** Dictionary ìºì‹± ì‚¬ìš©

**ì´ìœ :**
- `FindCurrencyByTitle("Gold")`ê°€ ë¹ˆë²ˆí•˜ê²Œ í˜¸ì¶œë¨
- List: O(n) ìˆœíšŒ
- Dictionary: O(1) ì¡°íšŒ

**êµ¬í˜„:**
```csharp
// Load ì‹œ Dictionary ìƒì„±
foreach (Currency currency in currencyDatabase.Items)
{
    currencyDic[currency.Title] = madeCurrency;
}
```

---

### 3. ìë™ ì €ì¥ vs ìˆ˜ë™ ì €ì¥

**ë¬¸ì œ:** ì–¸ì œ Save()ë¥¼ í˜¸ì¶œí•  ê²ƒì¸ê°€?

**ê²°ì •:** ì˜êµ¬ í™”íëŠ” ìë™ ì €ì¥, ë¹„ì˜êµ¬ëŠ” ì €ì¥ ì•ˆ í•¨

**ì´ìœ :**
- ì˜êµ¬ í™”í: ì‚¬ìš©ì ì§„í–‰ë„ ë³´ì¡´ í•„ìš” â†’ ë³€ê²½ ì¦‰ì‹œ ì €ì¥
- ë¹„ì˜êµ¬ í™”í: ìŠ¤í…Œì´ì§€ ì¬ì‹œì‘ ì‹œ ë¦¬ì…‹ â†’ ì €ì¥ ë¶ˆí•„ìš”
- ì´ë²¤íŠ¸ ê¸°ë°˜ ìë™ ì €ì¥ìœ¼ë¡œ ì €ì¥ ëˆ„ë½ ë°©ì§€

**êµ¬í˜„:**
```csharp
if (currency.IsPermanent)
{
    madeCurrency.onAmountChanged += (noUse) => RequestSave(); // ë¹„ë™ê¸° ì €ì¥
}
```

---

### 4. ë©”ì¸ ìŠ¤ë ˆë“œ vs ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ ğŸš€

**ë¬¸ì œ:** ì €ì¥ ì‹œ ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ìœ¼ë¡œ ì¸í•œ í”„ë ˆì„ ë“œë¡­ ë°œìƒ

**ì›ì¸ ë¶„ì„:**
```
ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ ì‹œ:
â”œâ”€ JSON ì§ë ¬í™” (CPU Bound)    â†’ 50ms ë©”ì¸ ìŠ¤ë ˆë“œ ì ìœ 
â”œâ”€ AES ì•”í˜¸í™” (CPU Bound)      â†’ 30ms ë©”ì¸ ìŠ¤ë ˆë“œ ì ìœ 
â””â”€ íŒŒì¼ ì“°ê¸° (I/O Bound)       â†’ 20ms ë©”ì¸ ìŠ¤ë ˆë“œ ëŒ€ê¸°
                                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                 ì´ 100ms ë¸”ë¡ â†’ í”„ë ˆì„ ë“œë¡­ ë°œìƒ
                                 (60fps = 16.6ms/frame)
```

**ê²°ì •:** ë©€í‹°ìŠ¤ë ˆë“œ ë¹„ë™ê¸° ì €ì¥ (Async/Await + UniTask)

**í•´ê²° ì „ëµ:**

| ê³„ì¸µ | ë¬¸ì œ | í•´ê²° ë°©ë²• | íš¨ê³¼ |
|------|------|----------|------|
| **ìŠ¤ë ˆë“œ ë¶„ë¦¬** | ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ | `UniTask.RunOnThreadPool()` | âœ… **ë¸”ë¡ 0ms** |
| I/O ìµœì í™” | I/O ë¹ˆë„ ê³¼ë‹¤ | Debouncing Pattern | âœ… 90% ê°ì†Œ |
| **ì•ˆì •ì„± ë³´ì¥** | ì €ì¥ ë¬´í•œ ì—°ê¸° (ê¸°ì•„ ìƒíƒœ) | **Max Wait Time** | âœ… 5ì´ˆë§ˆë‹¤ ìµœì†Œ 1ë²ˆ ì €ì¥ |
| ë°ì´í„° ë¬´ê²°ì„± | ë°ì´í„° ì†ì‹¤ | Pending Save + Dirty Flag | âœ… ì†ì‹¤ ë°©ì§€ |

**ìŠ¤ë ˆë“œ ë¶„ë¦¬ êµ¬í˜„:**
```csharp
// âŒ Before: ëª¨ë“  ì‘ì—…ì´ ë©”ì¸ ìŠ¤ë ˆë“œ
void Save()
{
    string json = JsonConvert.SerializeObject(data);    // ë©”ì¸ ìŠ¤ë ˆë“œ 50ms ì ìœ 
    string encrypted = FileIO.EncryptString(json);       // ë©”ì¸ ìŠ¤ë ˆë“œ 30ms ì ìœ 
    File.WriteAllText(path, encrypted);                  // ë©”ì¸ ìŠ¤ë ˆë“œ 20ms ëŒ€ê¸°
}

// âœ… After: CPU/IO Bound ì‘ì—…ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ
async UniTask SaveAsync()
{
    // ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (ë¹ ë¦„)
    var dataToSave = CollectData();

    // ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œë¡œ ì´ë™ â† í•µì‹¬!
    await UniTask.RunOnThreadPool(() =>
    {
        string json = JsonConvert.SerializeObject(dataToSave);   // ë°±ê·¸ë¼ìš´ë“œ 50ms
        string encrypted = FileIO.EncryptString(json);            // ë°±ê·¸ë¼ìš´ë“œ 30ms
        File.WriteAllText(path, encrypted);                       // ë°±ê·¸ë¼ìš´ë“œ 20ms
    });
    // ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ 0ms! âœ…
}
```

**Trade-off ë¶„ì„:**

| ì ‘ê·¼ë²• | ì¥ì  | ë‹¨ì  | ê²°ì • |
|--------|------|------|------|
| **ë©”ì¸ ìŠ¤ë ˆë“œë§Œ ì‚¬ìš©** | - êµ¬í˜„ ê°„ë‹¨<br>- ë””ë²„ê¹… ìš©ì´ | - í”„ë ˆì„ ë“œë¡­ ë°œìƒ<br>- ëª¨ë°”ì¼ì—ì„œ ë²„ë²…ì„<br>- ìœ ì € ê²½í—˜ ì €í•˜ | âŒ ë°°ì œ |
| **ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ í™œìš©** | - **í”„ë ˆì„ ë“œë¡­ 0**<br>- ë¶€ë“œëŸ¬ìš´ ê²Œì„í”Œë ˆì´<br>- ëª¨ë°”ì¼ ìµœì í™” | - ë³µì¡ë„ ì¦ê°€<br>- ìŠ¤ë ˆë“œ ì•ˆì „ì„± ê³ ë ¤ | âœ… **ì„ íƒ** |

**ì™œ UniTaskë¥¼ ì„ íƒí–ˆë‚˜? (C# Task vs UniTask)**

| í•­ëª© | C# Task | UniTask â­ | ì„ íƒ ì´ìœ  |
|------|---------|-----------|----------|
| **GC í• ë‹¹** | âœ— ìˆìŒ (class) | âœ… **ì œë¡œ** (ValueTask) | ëª¨ë°”ì¼ í•„ìˆ˜ |
| **Unity í†µí•©** | âœ— ìˆ˜ë™ ì²˜ë¦¬ | âœ… **PlayerLoop í†µí•©** | ìƒëª…ì£¼ê¸° ìë™ ê´€ë¦¬ |
| **ìŠ¤ë ˆë“œ í’€** | ThreadPool.QueueUserWorkItem | `RunOnThreadPool()` | Unity ìµœì í™” |
| **ì„±ëŠ¥** | ë²”ìš© | **Unity íŠ¹í™”** | í”„ë ˆì„ë‹¹ ë¶€í•˜ ê°ì†Œ |

**ê²°ë¡ :**
- ëª¨ë°”ì¼ íƒ€ê²Ÿ + ë¹ˆë²ˆí•œ ì €ì¥ â†’ UniTaskì˜ **ì œë¡œ GC**ê°€ í•µì‹¬
- C# TaskëŠ” ë§¤ í˜¸ì¶œë§ˆë‹¤ GC í• ë‹¹ â†’ ëˆ„ì ë˜ë©´ GC Spike ë°œìƒ

**ì„±ëŠ¥ ë¹„êµ (ì‹¤ì œ ì¸¡ì • ì˜ˆìƒ):**

```
ì‹œë‚˜ë¦¬ì˜¤: 1ì´ˆì— 10ë²ˆ ì €ì¥ í˜¸ì¶œ

[ë™ê¸° ë°©ì‹]
ë©”ì¸ ìŠ¤ë ˆë“œ: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (1000ms ë¸”ë¡)
ê²Œì„ ë¡œì§:   (ë©ˆì¶¤) â†’ í”„ë ˆì„ ë“œë¡­ ë°œìƒ
ê²°ê³¼: 6~10fpsë¡œ ì €í•˜

[ë¹„ë™ê¸° ë°©ì‹ (UniTask)]
ë©”ì¸ ìŠ¤ë ˆë“œ: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (0ms ë¸”ë¡)
ë°±ê·¸ë¼ìš´ë“œ:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (1000ms ì‘ì—…)
ê²Œì„ ë¡œì§:   â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶â–¶ (ê³„ì† ì‹¤í–‰)
ê²°ê³¼: 60fps ì•ˆì •ì  ìœ ì§€ âœ…
```

**í•µì‹¬ ì½”ë“œ:**
- [`CurrencyManager.cs:74-113`](CurrencyManager.cs) - RequestSave() ë©€í‹°ìŠ¤ë ˆë“œ ë¡œì§
- [`DataManager.cs:55-99`](../Utils/DataManager.cs) - SaveToFileAsync() ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰

